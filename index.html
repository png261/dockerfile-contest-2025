<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xây Dựng Dockerfile Chất Lượng Cao</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/dist/theme/black.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/highlight/monokai.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Base styling */
		body, .reveal {
			font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		}

		.reveal {
			font-size: 36px;
			font-weight: 400;
		}

		.reveal h1 {
			font-size: 2.5em;
			text-transform: none;
		}
		.reveal h2 {
			font-size: 1.8em;
			text-transform: none;
		}
		.reveal h3 {
			font-size: 1.4em;
			text-transform: none;
		}
		.reveal pre {
			font-size: 0.75em;
			width: 100%;
		}
		.reveal code,
		pre code,
		pre {
			font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
			font-size: 1.02em;
			letter-spacing: 0.2px;
		}
		.reveal .slides section {
			text-align: left;
		}
		.reveal .slides section.center {
			text-align: center;
		}
		.reveal ul, .reveal ol {
			display: block;
		}
		.reveal pre code {
			max-height: 700px;
			overflow: auto;
		}

		/* Table Styling - BIGGER */
		.reveal table {
			font-size: 0.85em;
			margin: 20px auto;
			border-collapse: collapse;
			width: 90%;
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		.reveal table th {
			background: rgba(255, 255, 255, 0.15);
			padding: 15px 20px;
			border: 2px solid #42affa;
			font-weight: bold;
			text-align: left;
		}
		.reveal table td {
			padding: 12px 20px;
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		.reveal table tbody tr:last-child td {
			border-bottom: 2px solid rgba(255, 255, 255, 0.3);
		}
		.reveal table tr:nth-child(even) {
			background: rgba(255, 255, 255, 0.05);
		}
		.reveal table tr:hover {
			background: rgba(66, 175, 250, 0.1);
		}

		.highlight-box {
			background: rgba(255, 255, 255, 0.1);
			padding: 20px;
			border-radius: 10px;
			margin: 20px 0;
		}
		.good { color: #4ade80; }
		.bad { color: #f87171; }
		.metric-value {
			color: #42affa;
			font-weight: bold;
		}
		
		/* Sidebar Navigation - Minimal Design */
		#sidebar {
			position: fixed;
			top: 0;
			font-weight: bold;
			right: -500px; /* Increased to fully hide sidebar + shadow */
			width: 400px;
			height: 100vh;
			border-left: 1px solid rgba(66, 175, 250, 0.3);
			transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			z-index: 1000;
			overflow-y: auto;
			padding: 30px 20px;
			box-shadow: -10px 0 30px rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
		}
		
		#sidebar::-webkit-scrollbar {
			width: 6px;
		}
		
		#sidebar::-webkit-scrollbar-track {
			background: rgba(255, 255, 255, 0.05);
		}
		
		#sidebar::-webkit-scrollbar-thumb {
			background: rgba(66, 175, 250, 0.3);
			border-radius: 3px;
		}
		
		#sidebar::-webkit-scrollbar-thumb:hover {
			background: rgba(66, 175, 250, 0.5);
		}
		
		#sidebar.active {
			right: 0;
		}
		
		#sidebar h3 {
			color: #42affa;
			margin: 0 0 20px 0;
			font-size: 1em; /* increased from 0.9em */
			text-transform: uppercase;
			letter-spacing: 2px;
			font-weight: 600;
			border-bottom: 1px solid rgba(66, 175, 250, 0.3);
			padding-bottom: 12px;
		}
		
		#sidebar ul {
			list-style: none;
			padding: 0;
			margin: 0;
		}
		
		#sidebar ul li {
			margin: 0;
		}
		
		#sidebar ul li a {
			color: rgba(255, 255, 255, 0.8);
			text-decoration: none;
			display: block;
			padding: 10px 12px;
			border-radius: 6px;
			transition: all 0.2s ease;
			font-size: 0.9em; /* increased from 0.75em */
			border-left: 2px solid transparent;
		}
		
		#sidebar ul li a:hover {
			background: rgba(66, 175, 250, 0.1);
			color: #42affa;
			transform: translateX(-3px);
		}
		
		#sidebar ul li.section-header {
			font-weight: 700;
			color: #42affa;
			margin-top: 20px;
			margin-bottom: 8px;
			font-size: 0.85em; /* increased from 0.7em */
			text-transform: uppercase;
			letter-spacing: 1px;
			padding-left: 12px;
			opacity: 0.9;
		}
		
		#sidebar ul li.section-header:first-child {
			margin-top: 0;
		}
		
		#sidebar ul li.subsection a {
			padding-left: 28px;
			font-size: 0.82em; /* increased from 0.7em */
			color: rgba(255, 255, 255, 0.8);
		}
		
		/* Minimal Toggle Button */
		#toggle-sidebar {
			position: fixed;
			top: 15px;
			right: 15px;
			width: 40px;
			height: 40px;
			background: inherit;
			border: 0;
			border-radius: 6px;
			cursor: pointer;
			z-index: 1001;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s ease;
			backdrop-filter: blur(5px);
		}
		
		#toggle-sidebar span {
			display: block;
			width: 18px;
			height: 2px;
			background: #42affa;
			position: relative;
			transition: all 0.3s ease;
		}
		
		#toggle-sidebar span::before,
		#toggle-sidebar span::after {
			content: '';
			position: absolute;
			width: 18px;
			height: 2px;
			background: #42affa;
			transition: all 0.3s ease;
		}
		
		#toggle-sidebar span::before {
			top: -6px;
			left: 0px;
		}
		
		#toggle-sidebar span::after {
			top: 6px;
			left: 0px;
		}
		
		#toggle-sidebar.active {
			background: transparent;
		}
		
		#toggle-sidebar.active span {
			background: transparent;
		}
		
		#toggle-sidebar.active span::before {
			transform: rotate(45deg);
			top: 0;
		}
		
		#toggle-sidebar.active span::after {
			transform: rotate(-45deg);
			top: 0;
		}
		
		/* Overlay */
		#sidebar-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			z-index: 999;
			display: none;
			backdrop-filter: blur(2px);
			transition: opacity 0.3s ease;
		}
		
		#sidebar-overlay.active {
			display: block;
		}
		
		/* Active slide indicator */
		#sidebar ul li a.active-slide {
			background: rgba(66, 175, 250, 0.2);
			color: #42affa;
			font-weight: 600;
		}
    </style>
</head>
<body>
    <!-- Minimal Toggle Button -->
    <button id="toggle-sidebar" aria-label="Toggle Navigation">
        <span></span>
    </button>
    
    <!-- Overlay -->
    <div id="sidebar-overlay"></div>
    
    <!-- Sidebar Navigation -->
    <nav id="sidebar">
        <h3>Dockerfile Contest 2025</h3>
        <ul>
            <li><a href="#" data-slide="1">Architecture Overview</a></li>
            <li><a href="#" data-slide="2">Kỹ Thuật</a></li>
            <li><a href="#" data-slide="3">Đánh giá</a></li>
            
            <li class="section-header">Stage 1: Builder</li>
            <li><a href="#" data-slide="5">Overview</a></li>
            <li class="subsection"><a href="#" data-slide="6">Digest-pinned</a></li>
            <li class="subsection"><a href="#" data-slide="7">Corepack</a></li>
            <li class="subsection"><a href="#" data-slide="8">BuildKit Cache</a></li>
            <li class="subsection"><a href="#" data-slide="9">Performance</a></li>
            <li class="subsection"><a href="#" data-slide="10">Layer Optimization</a></li>
            <li class="subsection"><a href="#" data-slide="11">Cleanup Artifacts</a></li>
            
            <li class="section-header">Stage 2: Nginx</li>
            <li><a href="#" data-slide="12">Overview</a></li>
            <li class="subsection"><a href="#" data-slide="13">SHA256 Verification</a></li>
            <li class="subsection"><a href="#" data-slide="14">Minimal Modules</a></li>
            <li class="subsection"><a href="#" data-slide="15">Modules Disabled</a></li>
            <li class="subsection"><a href="#" data-slide="16">Static Linking</a></li>
            <li class="subsection"><a href="#" data-slide="17">Dynamic vs Static</a></li>
            <li class="subsection"><a href="#" data-slide="18">UPX Compression</a></li>
            <li class="subsection"><a href="#" data-slide="19">UPX Trade-offs</a></li>
            
            <li class="section-header">Stage 3: Compression</li>
            <li><a href="#" data-slide="20">Overview</a></li>
            <li class="subsection"><a href="#" data-slide="21">Pre-compression</a></li>
            <li class="subsection"><a href="#" data-slide="22">Parallel Compression</a></li>
            <li class="subsection"><a href="#" data-slide="23">Performance</a></li>
            <li class="subsection"><a href="#" data-slide="24">Max Compression</a></li>
            <li class="subsection"><a href="#" data-slide="25">Results</a></li>
            
            <li class="section-header">Stage 4: Rootfs</li>
            <li><a href="#" data-slide="26">Overview</a></li>
            <li class="subsection"><a href="#" data-slide="27">Rootfs Pattern</a></li>
            <li class="subsection"><a href="#" data-slide="28">User Database</a></li>
            <li class="subsection"><a href="#" data-slide="29">/etc/passwd</a></li>
            <li class="subsection"><a href="#" data-slide="30">Temp Directories</a></li>
            <li class="subsection"><a href="#" data-slide="31">Ownership</a></li>
            <li class="subsection"><a href="#" data-slide="32">Permissions</a></li>
            
            <li class="section-header">Stage 5: Final</li>
            <li><a href="#" data-slide="33">Overview</a></li>
            <li class="subsection"><a href="#" data-slide="34">FROM scratch</a></li>
            <li class="subsection"><a href="#" data-slide="35">Requirements</a></li>
            <li class="subsection"><a href="#" data-slide="36">Security Benefits</a></li>
            <li class="subsection"><a href="#" data-slide="37">OCI Labels</a></li>
            <li class="subsection"><a href="#" data-slide="38">Non-root USER</a></li>
            <li class="subsection"><a href="#" data-slide="39">Comparison</a></li>
            <li class="subsection"><a href="#" data-slide="40">HEALTHCHECK</a></li>
            <li class="subsection"><a href="#" data-slide="41">Health Command</a></li>
            
            <li class="section-header">Kết Thúc</li>
            <li><a href="#" data-slide="42">Final Metrics</a></li>
        </ul>
    </nav>

    <div class="reveal">
        <div class="slides">

            <!-- Title Slide -->
            <section class="center">
                <h4>DOCKERFILE CONTEST 2025</h4>
                <h1>TOP 1 VITE REACT</h1>
                <div style="margin-top: 60px;">
                    <h3 style="color: #42affa;">Nguyễn Hữu Phương</h3>
                    <p style="font-size: 0.8em; margin-top: 20px;">
                        <strong>GitHub:</strong> <a href="https://github.com/png261" style="color: #60d0ff;">github.com/png261</a><br>
                        <strong>Email:</strong> <a href="mailto:nhphuong.code@gmail.com" style="color: #60d0ff;">nhphuong.code@gmail.com</a>
                    </p>
                </div>
            </section>

            <!-- Architecture Overview -->
            <section>
                <h2>Architecture Overview</h2>
                <h3 style="text-align: center; color: #42affa;">MULTI-STAGE BUILD PIPELINE (5 stages)</h3>

                <table>
                    <thead>
                        <tr>
                            <th>Stage</th>
                            <th>Input</th>
                            <th>Output</th>
                            <th>Size</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>1: Application Builder</strong><br><code>node:20-alpine</code></td>
                            <td>package.json, source code</td>
                            <td>/app/dist (optimized assets)</td>
                            <td>450 MB <span style="color: #a0a0a0;">(discarded)</span></td>
                            <td><span class="good">35s</span> (cached) / <span class="bad">300s</span> (cold)</td>
                        </tr>
                        <tr>
                            <td><strong>2: Nginx Builder</strong><br><code>alpine:3.20</code></td>
                            <td>nginx-1.26.2.tar.gz</td>
                            <td>Static nginx binary (2.1 MB)</td>
                            <td>450 MB <span style="color: #a0a0a0;">(discarded)</span></td>
                            <td>180-240s</td>
                        </tr>
                        <tr>
                            <td><strong>3: Compressor</strong><br><code>alpine:3.20</code></td>
                            <td>Static assets</td>
                            <td>Pre-compressed (.gz + .br)</td>
                            <td>150 MB <span style="color: #a0a0a0;">(discarded)</span></td>
                            <td><span class="good">11s</span> (parallel)</td>
                        </tr>
                        <tr>
                            <td><strong>4: Rootfs Prep</strong><br><code>alpine:3.20</code></td>
                            <td>Configs, assets</td>
                            <td>Complete rootfs structure</td>
                            <td>50 MB <span style="color: #a0a0a0;">(discarded)</span></td>
                            <td>2-3s</td>
                        </tr>
                        <tr>
                            <td><strong>5: Final</strong><br><code>FROM scratch</code></td>
                            <td>Nginx (2.1MB), rootfs (3MB)</td>
                            <td>Production image</td>
                            <td><span class="metric-value">5.38 MB ✓</span></td>
                            <td><span class="good">1s</span></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Kỹ Thuật Tổng Hợp -->
            <section>
                <h2>Kỹ Thuật</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div class="highlight-box">
                        <h3>Tối ưu Build </h3>
                        <ul>
                            <li>BuildKit cache mounts<br><small>93% faster rebuilds</small></li>
                            <li>Layer optimization<br><small>Efficient caching</small></li>
                            <li>Parallel compression<br><small>7x faster</small></li>
                            <li>Digest-pinned bases<br><small>Reproducible builds</small></li>
                        </ul>
                    </div>
                    <div class="highlight-box">
                        <h3>Tối ưu kích thước</h3>
                        <ul>
                            <li>FROM scratch<br><small>Zero base size</small></li>
                            <li>Static linking<br><small>No dependencies</small></li>
                            <li>Minimal modules<br><small>76% smaller nginx</small></li>
                            <li>UPX compression<br><small>56% binary reduction</small></li>
                            <li>Artifact cleanup<br><small>12-15 MB saved</small></li>
                            <li>Pre-compression<br><small>75% network reduction</small></li>
                        </ul>
                    </div>
                    <div class="highlight-box">
                        <h3>Bảo mật</h3>
                        <ul>
                            <li> FROM scratch<br><small>0 attack surface</small></li>
                            <li> Non-root user (65534)<br><small>Least privilege</small></li>
                            <li> Static binary<br><small>No lib vulnerabilities</small></li>
                            <li> SHA256 verification<br><small>Supply chain safety</small></li>
                            <li> No shell<br><small>No command injection</small></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Metrics Summary -->
            <section>
                <h2>Đánh giá</h2>
                <table>
                    <thead>
                        <tr>
                            <th colspan="2">FINAL RESULTS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Image size</strong></td>
                            <td><span class="metric-value">5.38 MB</span></td>
                        </tr>
                        <tr>
                            <td><strong>Base image</strong></td>
                            <td>scratch (0 MB)</td>
                        </tr>
                        <tr>
                            <td><strong>Layers</strong></td>
                            <td>2 data layers</td>
                        </tr>
                        <tr>
                            <td><strong>CVEs</strong></td>
                            <td><span class="metric-value">0 vulnerabilities</span></td>
                        </tr>
                        <tr>
                            <td><strong>Startup time</strong></td>
                            <td><span class="good">3-5 seconds</span></td>
                        </tr>
                        <tr>
                            <td><strong>Memory (idle)</strong></td>
                            <td><span class="good">10-12 MB</span></td>
                        </tr>
                        <tr>
                            <td><strong>Shutdown time</strong></td>
                            <td><span class="good">0.212 seconds</span></td>
                        </tr>
                        <tr>
                            <td><strong>HTTP response</strong></td>
                            <td><span class="good">&lt; 10ms</span></td>
                        </tr>
                        <tr style="border-top: 2px solid rgba(255,255,255,0.3);">
                            <td><strong>Build time (cold)</strong></td>
                            <td>7.5 minutes</td>
                        </tr>
                        <tr>
                            <td><strong>Build time (warm)</strong></td>
                            <td><span class="good">45 seconds</span></td>
                        </tr>
                        <tr style="border-top: 2px solid rgba(255,255,255,0.3);">
                            <td><strong>vs nginx:alpine</strong></td>
                            <td><span class="metric-value">92.5% smaller</span></td>
                        </tr>
                        <tr>
                            <td><strong>vs nginx:latest</strong></td>
                            <td><span class="metric-value">97.2% smaller</span></td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Chi Tiết Các Stage Header -->
            <section class="center">
                <h1>CHI TIẾT CÁC STAGE</h1>
            </section>

            <!-- Stage 1 -->
            <section>
                <h2>2.1 Stage 1: Application Builder</h2>
                <p><strong>Mục đích:</strong> Build ứng dụng Vite React thành static assets</p>
                <pre><code class="language-dockerfile">FROM node:${NODE_VERSION}-alpine@sha256:... AS builder

WORKDIR /app

# Setup pnpm with corepack
ENV PNPM_HOME="/pnpm" \
    PATH="$PNPM_HOME:$PATH"
RUN corepack enable && corepack prepare pnpm@9.12.2 --activate

# Install dependencies with cache mount
COPY package.json pnpm-lock.yaml .npmrc ./
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm install --frozen-lockfile --prefer-offline

# Copy source and build configuration
COPY tsconfig.json tsconfig.node.json vite.config.ts ./
COPY postcss.config.js tailwind.config.ts biome.json ./
COPY index.html ./
COPY public ./public
COPY src ./src

# Build and clean artifacts
ENV NODE_ENV=production
RUN pnpm build && \
    find dist -type f \( -name "*.map" -o -name ".*" \) -delete && \
    rm -f dist/stats.html
</code></pre>
            </section>

            <!-- Digest-pinned - MOVED TO STAGE 1 -->
            <section>
                <h3>Kỹ thuật 1: Digest-pinned Base Images</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p class="bad"><strong>❌ BAD: Tag-based (mutable)</strong></p>
                        <pre><code class="language-dockerfile">FROM node:20-alpine</code></pre>
                    </div>
                    <div>
                        <p class="good"><strong>✓ GOOD: Digest-pinned (immutable)</strong></p>
                        <pre><code class="language-dockerfile">FROM node:20-alpine@sha256:2d5e8a8a...</code></pre>
                    </div>
                </div>
                <p><strong>Giải thích:</strong></p>
                <ul>
                    <li>Tag (<code>20-alpine</code>) có thể thay đổi → supply chain attack</li>
                    <li>Digest (<code>sha256:...</code>) immutable → reproducible builds</li>
                </ul>
                <p><em>"Always use digest-pinned images in production to prevent tag mutation attacks"</em> <br/><strong>- OWASP Docker Security Cheat Sheet</strong></p>
            </section>

            <!-- Corepack -->
            <section>
                <h3>Kỹ thuật 2: Corepack thay vì npm install pnpm</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p class="bad"><strong>❌ Cách thông thường:</strong></p>
                        <pre><code class="language-dockerfile">RUN npm install -g pnpm@9.12.2</code></pre>
                    </div>
                    <div>
                        <p class="good"><strong>✓ Cách tối ưu:</strong></p>
                        <pre><code class="language-dockerfile">RUN corepack enable && \
    corepack prepare pnpm@9.12.2 \
        --activate</code></pre>
                    </div>
                </div>
                <p><strong>Lợi ích:</strong></p>
                <ul>
                    <li>Không cần download từ npm registry</li>
                    <li>Corepack built-in Node.js 16+</li>
                    <li>Version locking chính xác</li>
                    <li>Nhanh hơn ~5-10 giây</li>
                </ul>
            </section>

            <!-- BuildKit Cache Mount -->
            <section>
                <h3>Kỹ thuật 3: BuildKit Cache Mount</h3>
                <pre><code class="language-dockerfile">COPY package.json pnpm-lock.yaml .npmrc ./
RUN --mount=type=cache,id=pnpm,target=/pnpm/store \
    pnpm install --frozen-lockfile --prefer-offline</code></pre>
                <p><strong>Giải thích từng phần:</strong></p>
                <ol>
                    <li><code>--mount=type=cache</code>: BuildKit cache mount</li>
                    <li><code>id=pnpm</code>: Cache ID (unique per project)</li>
                    <li><code>target=/pnpm/store</code>: Mount vào pnpm store location</li>
                    <li><code>--frozen-lockfile</code>: Không update lockfile (reproducible)</li>
                    <li><code>--prefer-offline</code>: Ưu tiên cache local</li>
                </ol>
            </section>

            <!-- Performance comparison -->
            <section>
                <h3>So sánh performance</h3>
                <pre><code>Build lần 1 (cold cache):
├─ Download packages: 180s
├─ Install:           120s
└─ Total:            300s

Build lần 2 (warm cache):
├─ Download packages: 0s    (cache hit)
├─ Install:          20s
└─ Total:            20s    (93% faster)</code></pre>
                <p>Cache mount không persist trong image (không tăng size)</p>
            </section>

            <!-- Layer Optimization -->
            <section>
                <h3>Kỹ thuật 4: Layer Optimization</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p class="good"><strong>✓ GOOD: Separate dependencies from source</strong></p>
                        <pre><code class="language-dockerfile">COPY package.json pnpm-lock.yaml ./
RUN pnpm install
COPY src ./src
RUN pnpm build</code></pre>
                    </div>
                    <div>
                        <p class="bad"><strong>❌ BAD: Copy everything, breaks cache</strong></p>
                        <pre><code class="language-dockerfile">COPY . ./
RUN pnpm install && pnpm build</code></pre>
                    </div>
                </div>
                <p><strong>Giải thích Docker Layer Caching:</strong></p>
                <ul>
                    <li>Mỗi RUN/COPY = 1 layer</li>
                    <li>Layer cache invalidate nếu file thay đổi</li>
                    <li>Dependencies thay đổi ít → cache lâu</li>
                    <li>Source code thay đổi nhiều → rebuild thường xuyên</li>
                </ul>
                <p><strong>Kết quả:</strong> 90% builds chỉ rebuild source, không reinstall deps</p>
            </section>

            <!-- Cleanup Build Artifacts -->
            <section>
                <h3>Kỹ thuật 5: Cleanup Build Artifacts</h3>
                <pre><code class="language-dockerfile">ENV NODE_ENV=production
RUN pnpm build && \
    find dist -type f \
      \( -name "*.map" -o -name ".*" \) -delete && \
    rm -f dist/stats.html</code></pre>
                <p><strong>Artifacts được xóa:</strong></p>
                <ul>
                    <li><code>*.map</code>: Source maps (12-15 MB)</li>
                    <li><code>.DS_Store</code>, <code>.gitkeep</code>: Hidden files</li>
                    <li><code>stats.html</code>: Webpack bundle analyzer</li>
                </ul>
                <p><strong>Lý do:</strong></p>
                <ul>
                    <li>Source maps: Chỉ cần cho development debugging</li>
                    <li>Production không cần expose source code</li>
                    <li>Tiết kiệm 12-15 MB</li>
                </ul>
            </section>

            <!-- Stage 2 -->
            <section>
                <h2>2.2 Stage 2: Nginx Static Binary Builder</h2>
                <p><strong>Mục đích:</strong> Compile nginx thành static binary với minimal modules</p>
                <pre><code class="language-dockerfile">
FROM alpine:${ALPINE_VERSION}@sha256:... AS nginx-builder

ARG NGINX_VERSION
ARG TARGETPLATFORM
ARG BUILDPLATFORM
ENV NGINX_SHA256=...

# Log build platform info for multi-arch
RUN echo "Building on $BUILDPLATFORM for $TARGETPLATFORM"

# Install build dependencies
RUN apk add --no-cache \
    gcc g++ musl-dev make linux-headers curl \
    pcre-dev pcre2-dev zlib-dev zlib-static \
    openssl-dev openssl-libs-static upx

# Download and verify nginx
WORKDIR /tmp
RUN curl -fSL "https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz" -o nginx.tar.gz && \
    echo "${NGINX_SHA256}  nginx.tar.gz" | sha256sum -c -

# Build fully static nginx with minimal modules
RUN tar -xzf nginx.tar.gz && \
    cd "nginx-${NGINX_VERSION}" && \
    ./configure \
        --prefix=/usr/local/nginx \
        --sbin-path=/usr/local/nginx/sbin/nginx \
        --conf-path=/etc/nginx/nginx.conf \
        --pid-path=/run/nginx.pid \
        --lock-path=/run/nginx.lock \
        --error-log-path=/dev/stderr \
        --http-log-path=/dev/stdout \
        --user=nobody \
        --group=nobody \
        # Performance features
        --with-threads \
        --with-file-aio \
        --with-http_ssl_module \
        --with-http_v2_module \
        --with-http_gzip_static_module \
        --with-http_stub_status_module \
        --with-pcre \
        --with-pcre-jit \
        # Static linking and optimization
        --with-cc-opt='-static -Os -ffunction-sections -fdata-sections' \
        --with-ld-opt='-static -Wl,--gc-sections' \
        # Disable unnecessary modules
        --without-http_charset_module \
        --without-http_ssi_module \
        --without-http_userid_module \
        --without-http_auth_basic_module \
        --without-http_mirror_module \
        --without-http_autoindex_module \
        --without-http_geo_module \
        --without-http_map_module \
        --without-http_split_clients_module \
        --without-http_referer_module \
        --without-http_rewrite_module \
        --without-http_proxy_module \
        --without-http_fastcgi_module \
        --without-http_uwsgi_module \
        --without-http_scgi_module \
        --without-http_grpc_module \
        --without-http_memcached_module \
        --without-http_limit_conn_module \
        --without-http_limit_req_module \
        --without-http_empty_gif_module \
        --without-http_browser_module \
        --without-http_upstream_hash_module \
        --without-http_upstream_ip_hash_module \
        --without-http_upstream_least_conn_module \
        --without-http_upstream_random_module \
        --without-http_upstream_keepalive_module \
        --without-http_upstream_zone_module \
        --without-mail_pop3_module \
        --without-mail_imap_module \
        --without-mail_smtp_module \
        --without-stream_limit_conn_module \
        --without-stream_access_module \
        --without-stream_geo_module \
        --without-stream_map_module \
        --without-stream_split_clients_module \
        --without-stream_return_module \
        --without-stream_set_module \
        --without-stream_upstream_hash_module \
        --without-stream_upstream_least_conn_module \
        --without-stream_upstream_random_module \
        --without-stream_upstream_zone_module && \
    make -j"$(nproc)" && \
    make install

# Optimize binary: strip symbols + UPX compression
RUN strip --strip-all /usr/local/nginx/sbin/nginx && \
    upx --best --lzma /usr/local/nginx/sbin/nginx && \
    /usr/local/nginx/sbin/nginx -V
</code></pre>
            </section>

            <!-- SHA256 Verification - NOW TECHNIQUE 1 -->
            <section>
                <h3>Kỹ thuật 1: SHA256 Verification</h3>
                <pre><code class="language-dockerfile">ENV NGINX_SHA256=627fe086209bba80a2853a0add9d958d7ebbdffa1a8467a5784c9a6b4f03d738

RUN curl -fSL \
    "https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz" \
    -o nginx.tar.gz && \
    echo "${NGINX_SHA256}  nginx.tar.gz" | sha256sum -c -</code></pre>
                <p><strong>Giải thích:</strong></p>
                <ul>
                    <li><code>sha256sum -c</code>: Verify checksum</li>
                    <li>Nếu checksum sai → build fail (detect tampering)</li>
                </ul>
                <p><strong>Bảo vệ khỏi:</strong></p>
                <ul>
                    <li>Man-in-the-middle attacks</li>
                    <li>Compromised download servers</li>
                    <li>Corrupted files</li>
                </ul>
            </section>

            <!-- Minimal Modules - NOW TECHNIQUE 2 -->
            <section>
                <h3>Kỹ thuật 2: Minimal Modules</h3>
                <pre><code class="language-dockerfile">
./configure \
    ...
    # Performance features
    --with-threads \
    --with-file-aio \
    --with-http_ssl_module \
    --with-http_v2_module \
    --with-http_gzip_static_module \
    --with-http_stub_status_module \
    --with-pcre \
    --with-pcre-jit \
    # Disable unnecessary modules
    --without-http_charset_module \
    --without-http_ssi_module \
    --without-http_userid_module \
    --without-http_auth_basic_module \
    --without-http_mirror_module \
    --without-http_autoindex_module \
    --without-http_geo_module \
    --without-http_map_module \
    --without-http_split_clients_module \
    --without-http_referer_module \
    --without-http_rewrite_module \
    --without-http_proxy_module \
    --without-http_fastcgi_module \
    --without-http_uwsgi_module \
    --without-http_scgi_module \
    --without-http_grpc_module \
    --without-http_memcached_module \
    --without-http_limit_conn_module \
    --without-http_limit_req_module \
    --without-http_empty_gif_module \
    --without-http_browser_module \
    --without-http_upstream_hash_module \
    --without-http_upstream_ip_hash_module \
    --without-http_upstream_least_conn_module \
    --without-http_upstream_random_module \
    --without-http_upstream_keepalive_module \
    --without-http_upstream_zone_module && \
make -j"$(nproc)" && \
make install
</code></pre>
            </section>

            <!-- Modules được disable -->
            <section>
                <h3>Modules được disable</h3>
                <div style="font-size: 0.85em;">
                    <p><strong>Proxy/Backend modules</strong> (không cần cho static site):</p>
                    <ul>
                        <li><code>http_proxy_module</code>: Reverse proxy</li>
                        <li><code>http_fastcgi_module</code>: FastCGI</li>
                        <li><code>http_uwsgi_module</code>: uWSGI</li>
                        <li><code>http_grpc_module</code>: gRPC</li>
                    </ul>
                    <p><strong>Authentication modules</strong> (không cần):</p>
                    <ul>
                        <li><code>http_auth_basic_module</code>: Basic auth</li>
                        <li><code>http_auth_request_module</code>: Auth subrequest</li>
                    </ul>
                    <p><strong>Advanced routing</strong> (không cần):</p>
                    <ul>
                        <li><code>http_rewrite_module</code>: URL rewriting</li>
                        <li><code>http_geo_module</code>: Geo-based routing</li>
                    </ul>
                </div>
                <p><strong>Kết quả:</strong> nginx binary từ 22 MB → 5.2 MB (76% smaller)</p>
            </section>

            <!-- Static Linking Details - NOW TECHNIQUE 3 -->
            <section>
                <h3>Kỹ thuật 3: Static Linking</h3>
                <pre><code class="language-dockerfile">./configure \
  --with-cc-opt='-static -Os -ffunction-sections -fdata-sections' \
  --with-ld-opt='-static -Wl,--gc-sections'</code></pre>
                <p><strong>Giải thích chi tiết:</strong></p>
                <div style="font-size: 0.8em;">
                    <p><strong>Compiler Flags (<code>--with-cc-opt</code>):</strong></p>
                    <ul>
                        <li><code>-static</code>: Link static libraries</li>
                        <li><code>-Os</code>: Optimize for Size</li>
                        <li><code>-ffunction-sections</code>: Each function in separate section</li>
                        <li><code>-fdata-sections</code>: Each data in separate section</li>
                    </ul>
                    <p><strong>Linker Flags (<code>--with-ld-opt</code>):</strong></p>
                    <ul>
                        <li><code>-static</code>: Create static binary</li>
                        <li><code>-Wl,--gc-sections</code>: Remove unused sections</li>
                    </ul>
                </div>
            </section>

            <!-- Static vs Dynamic -->
            <section>
                <h3>So sánh Dynamic vs Static</h3>
                <pre><code>DYNAMIC LINKING:
nginx binary:        1.2 MB
+ libc.so:          2.1 MB
+ libssl.so:        3.5 MB
+ libpcre.so:       0.8 MB
+ libz.so:          0.3 MB
─────────────────────────────
Total:              7.9 MB
Dependencies:       5 files

STATIC LINKING:
nginx binary:       5.2 MB
─────────────────────────────
Total:              5.2 MB
Dependencies:       0 files ✓</code></pre>
                <p><strong>Trade-off:</strong></p>
                <ul>
                    <li class="good">✓ No dependency hell</li>
                    <li class="good">✓ Works on FROM scratch</li>
                    <li class="bad">✗ Larger binary size</li>
                    <li class="bad">✗ Can't share libs between apps</li>
                </ul>
            </section>

            <!-- UPX Details - NOW TECHNIQUE 4 -->
            <section>
                <h3>Kỹ thuật 4: UPX Compression</h3>
                <pre><code class="language-dockerfile"># Strip symbols
RUN strip --strip-all /usr/local/nginx/sbin/nginx

# UPX compression
RUN upx --best --lzma /usr/local/nginx/sbin/nginx

# Verify still works
RUN /usr/local/nginx/sbin/nginx -V</code></pre>
                <p><strong>Chi tiết từng bước:</strong></p>
                <ul>
                    <li><strong>Bước 1:</strong> Strip symbols: 5.2 MB → 4.8 MB (8% reduction)</li>
                    <li><strong>Bước 2:</strong> UPX compression: 4.8 MB → 2.1 MB (56% reduction)</li>
                    <li><strong>Bước 3:</strong> Verify binary vẫn hoạt động</li>
                </ul>
            </section>

            <!-- UPX Trade-offs -->
            <section>
                <h3>UPX Trade-offs</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Advantages</th>
                            <th>Disadvantages</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="good">✓</span> 56% size reduction</td>
                            <td><span class="bad">✗</span> +50ms startup</td>
                        </tr>
                        <tr>
                            <td><span class="good">✓</span> Faster download</td>
                            <td><span class="bad">✗</span> +2MB RAM usage</td>
                        </tr>
                        <tr>
                            <td><span class="good">✓</span> Less disk usage</td>
                            <td><span class="bad">✗</span> Slower first run</td>
                        </tr>
                        <tr>
                            <td><span class="good">✓</span> Faster deployment</td>
                            <td><span class="bad">✗</span> Anti-virus flags</td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="margin-top: 30px;">Kết luận:</h3>
                <ul>
                    <li><strong>Production:</strong> <span class="good">✓ Recommended</span> (network > CPU)</li>
                    <li><strong>Development:</strong> <span class="bad">✗ Skip</span> (faster iteration)</li>
                </ul>
            </section>

            <!-- Stage 3 -->
            <section>
                <h2>2.3 Stage 3: Asset Compression</h2>
                <p><strong>Mục đích:</strong> Pre-compress static assets (gzip + brotli) để nginx serve trực tiếp</p>
                <pre><code class="language-dockerfile">
FROM alpine:${ALPINE_VERSION}@sha256:... AS compressor

RUN apk add --no-cache brotli gzip findutils

WORKDIR /app
COPY --from=builder /app/dist ./dist

# Parallel compression: gzip + brotli for all text-based assets
RUN find dist -type f \
    \( -name "*.html" -o -name "*.css" -o -name "*.js" -o \
       -name "*.json" -o -name "*.svg" -o -name "*.xml" \) \
    -print0 | xargs -0 -P"$(nproc)" -I {} sh -c 'gzip -9 -k -f "{}" && brotli -q 11 -f "{}"'
</code></pre>
            </section>

            <!-- Pre-compression comparison -->
            <section>
                <h3>Kỹ thuật 1: Pre-compression</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p class="bad"><strong>❌ Runtime compression (traditional):</strong></p>
                        <pre><code class="language-nginx"># Nginx compress on-the-fly
gzip on;
gzip_types text/css application/javascript;</code></pre>
                        <p><strong>Nhược điểm:</strong></p>
                        <ul>
                            <li>CPU overhead mỗi request</li>
                            <li>Slower first-byte time</li>
                            <li>Variable compression ratio</li>
                        </ul>
                    </div>
                    <div>
                        <p class="good"><strong>✓ Pre-compression (our approach):</strong></p>
                        <pre><code class="language-bash"># Compress during build
gzip -9 index.html → index.html.gz
brotli -q 11 index.html → index.html.br</code></pre>
                        <pre><code class="language-nginx"># Nginx serve pre-compressed
gzip_static on;</code></pre>
                        <p><strong>Ưu điểm:</strong></p>
                        <ul>
                            <li>Zero runtime CPU</li>
                            <li>Best compression ratio (slow algorithm OK)</li>
                            <li>Consistent performance</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Parallel Compression -->
            <section>
                <h3>Kỹ thuật 2: Parallel Compression</h3>
                <pre><code class="language-bash">find dist -type f \( -name "*.js" ... \) -print0 | \
  xargs -0 -P"$(nproc)" -I {} sh -c \
  'gzip -9 -k "{}" && brotli -q 11 "{}"'</code></pre>
                <p><strong>Giải thích từng phần:</strong></p>
                <ol style="font-size: 0.85em;">
                    <li><code>find dist -type f</code>: Tìm tất cả files</li>
                    <li><code>-name "*.js" -o -name "*.css"</code>: Filter theo extension</li>
                    <li><code>-print0</code>: Null-terminated (handle spaces)</li>
                    <li><code>xargs -0</code>: Read null-terminated</li>
                    <li><code>-P"$(nproc)"</code>: Parallel = số CPU cores</li>
                    <li><code>-I {}</code>: Replace string</li>
                    <li><code>sh -c '...'</code>: Execute shell command</li>
                </ol>
            </section>

            <!-- Performance so sánh -->
            <section>
                <h3>Performance so sánh</h3>
                <pre><code>Sequential compression (1 core):
├─ 150 files × 0.5s = 75 seconds

Parallel compression (8 cores):
├─ 150 files / 8 cores = 19 files/core
├─ 19 files × 0.5s = 9.5 seconds
└─ Speedup: 7.9x

Actual time:
├─ Sequential: 78s
└─ Parallel:   11s  (7.1x faster)</code></pre>
            </section>

            <!-- REPLACED: Gzip vs Brotli + Compression Quality Tuning → Max Compression Strategy -->
            <section>
                <h3>Kỹ thuật 3: Max Compression Strategy</h3>
                <pre><code class="language-bash">gzip -9 -k 
brotli -q 11
</code></pre>
                
                <p><strong>Chiến lược:</strong></p>
                <ul>
                    <li><strong>Gzip level -9</strong>: Maximum compression (70-75% reduction)</li>
                    <li><strong>Brotli quality 11</strong>: Maximum compression (75-85% reduction)</li>
                    <li><strong>Cả hai format</strong>: Nginx auto-select dựa trên browser support</li>
                </ul>

                <div class="highlight-box" style="margin-top: 20px;">
                    <p><strong>Đánh giá:</strong></p>
                    <ul>
                        <li class="good">✓ Best compression ratio (Brotli thường tốt hơn Gzip 5-10%)</li>
                        <li class="good">✓ Backward compatibility (Gzip cho browsers cũ)</li>
                        <li class="good">✓ Build time acceptable (2-3s cho Brotli-11 vs 0.5s cho level thấp hơn)</li>
                        <li class="good">✓ Zero runtime CPU overhead (pre-compressed)</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Kết luận:</strong> Build-time có thể chậm → chọn max quality để tối ưu runtime</p>
                </div>
            </section>

            <!-- Compression results - RENUMBERED -->
            <section>
                <h3>Compression results thực tế</h3>
                <pre><code>File: index.html
├─ Original:  14,523 bytes
├─ Gzip -9:    3,891 bytes  (73% smaller)
└─ Brotli-11:  3,247 bytes  (78% smaller)

File: main.js (React + ReactDOM)
├─ Original:  245,832 bytes
├─ Gzip -9:    68,234 bytes  (72% smaller)
└─ Brotli-11:  61,445 bytes  (75% smaller)

File: styles.css (Tailwind CSS)
├─ Original:  42,156 bytes
├─ Gzip -9:     8,923 bytes  (79% smaller)
└─ Brotli-11:   7,834 bytes  (81% smaller)</code></pre>
                <p><strong>Trung bình:</strong> Brotli tốt hơn Gzip 5-10%, cả hai đều giảm ~75% network transfer</p>
            </section>

            <!-- Stage 4 - RENUMBERED from slide 29 to 27 -->
            <section>
                <h2>2.4 Stage 4: Minimal Filesystem Preparation</h2>
                <p><strong>Mục đích:</strong> Chuẩn bị filesystem tối thiểu cho FROM scratch</p>
                <pre><code class="language-dockerfile">FROM alpine:${ALPINE_VERSION}@sha256:... AS rootfs

# Create directory structure
RUN mkdir -p \
    /rootfs/etc/nginx/conf.d \
    /rootfs/usr/share/nginx/html \
    /rootfs/var/log/nginx \
    /rootfs/var/cache/nginx \
    /rootfs/usr/local/nginx/{client_body,proxy,fastcgi,uwsgi,scgi}_temp \
    /rootfs/tmp \
    /rootfs/run && \
    chmod 1777 /rootfs/tmp

# Create minimal user database (nobody user)
RUN echo "nobody:x:65534:65534:nobody:/:/sbin/nologin" > /rootfs/etc/passwd && \
    echo "nobody:x:65534:" > /rootfs/etc/group

# Copy nginx configuration
COPY nginx.conf /rootfs/etc/nginx/conf.d/default.conf
COPY --from=nginx-builder /etc/nginx/mime.types /rootfs/etc/nginx/mime.types
COPY --from=compressor /app/dist /rootfs/usr/share/nginx/html

# Create main nginx.conf
RUN cat > /rootfs/etc/nginx/nginx.conf <<'EOF'
worker_processes auto;
error_log stderr warn;
pid /run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log /dev/stdout;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    server_tokens off;

    # Compression
    gzip on;
    gzip_static on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    include /etc/nginx/conf.d/*.conf;
}
EOF

# Set proper ownership
RUN chown -R 65534:65534 \
    /rootfs/usr/share/nginx/html \
    /rootfs/var/log/nginx \
    /rootfs/var/cache/nginx \
    /rootfs/usr/local/nginx \
    /rootfs/tmp \
    /rootfs/run

</code></pre>
            </section>

            <!-- Rootfs Pattern -->
            <section>
                <h3>Kỹ thuật 1: Rootfs Pattern</h3>
                <p><strong>Vấn đề:</strong> FROM scratch không có filesystem</p>
                <p><strong>Giải pháp:</strong> Chuẩn bị rootfs trong Alpine, copy sang scratch</p>
                <pre><code class="language-dockerfile"># Build rootfs in Alpine
RUN mkdir -p /rootfs/etc /rootfs/var ...

# Copy to final scratch image
FROM scratch
COPY --from=rootfs /rootfs /</code></pre>
                <p><strong>Giải thích:</strong></p>
                <ul>
                    <li><code>/rootfs</code> trong Alpine là "staging area"</li>
                    <li>COPY chuyển toàn bộ cấu trúc sang scratch</li>
                    <li>Scratch image không cần Alpine runtime</li>
                </ul>
            </section>

            <!-- Minimal User Database -->
            <section>
                <h3>Kỹ thuật 2: Minimal User Database</h3>
                <pre><code class="language-dockerfile"># Create nobody user (UID 65534)
RUN echo "nobody:x:65534:65534:nobody:/:/sbin/nologin" \
      > /rootfs/etc/passwd && \
    echo "nobody:x:65534:" > /rootfs/etc/group</code></pre>
                <p><strong>Giải thích /etc/passwd format:</strong></p>
                <pre><code>username:password:UID:GID:comment:home:shell
nobody:x:65534:65534:nobody:/:/sbin/nologin

• x            → password in /etc/shadow (not used)
• 65534        → UID (standard nobody UID)
• 65534        → GID
• /sbin/nologin → no shell (security)</code></pre>
            </section>

            <!-- Why /etc/passwd -->
            <section>
                <h3>Tại sao cần /etc/passwd trong FROM scratch?</h3>
                <pre><code class="language-dockerfile"># Final image
USER 65534:65534  # Nginx cần lookup UID → username</code></pre>
                <p><strong>Nginx code:</strong></p>
                <pre><code class="language-c">struct passwd *pwd = getpwuid(65534);
// Reads /etc/passwd to find "nobody"</code></pre>
                <p><strong>Không có /etc/passwd</strong> → Nginx warning (nhưng vẫn chạy)</p>
            </section>

            <!-- Nginx Temp Directories -->
            <section>
                <h3>Kỹ thuật 3: Nginx Temp Directories</h3>
                <pre><code class="language-dockerfile">RUN mkdir -p \
    /rootfs/usr/local/nginx/client_body_temp \
    /rootfs/usr/local/nginx/proxy_temp \
    /rootfs/usr/local/nginx/fastcgi_temp \
    /rootfs/usr/local/nginx/uwsgi_temp \
    /rootfs/usr/local/nginx/scgi_temp</code></pre>
                <p><strong>Tại sao cần?</strong></p>
                <p>Nginx cần temp dirs cho:</p>
                <ul>
                    <li><code>client_body_temp</code>: Large POST body buffering</li>
                    <li><code>proxy_temp</code>: Proxy response buffering</li>
                    <li><code>fastcgi_temp</code>: FastCGI buffering</li>
                    <li><code>uwsgi_temp</code>: uWSGI buffering</li>
                    <li><code>scgi_temp</code>: SCGI buffering</li>
                </ul>
                <p><strong>Lưu ý:</strong> Dù disable modules, nginx vẫn expect dirs tồn tại</p>
            </section>

            <!-- Ownership Setup -->
            <section>
                <h3>Kỹ thuật 4: Ownership Setup</h3>
                <pre><code class="language-dockerfile">RUN chown -R 65534:65534 \
    /rootfs/usr/share/nginx/html \
    /rootfs/var/log/nginx \
    /rootfs/var/cache/nginx \
    /rootfs/usr/local/nginx \
    /rootfs/tmp \
    /rootfs/run</code></pre>
                <p><strong>Tại sao cần chown?</strong></p>
                <p>Final image run as <code>USER 65534</code>:</p>
                <pre><code class="language-dockerfile">FROM scratch
COPY --from=rootfs /rootfs /
USER 65534:65534</code></pre>
                <p>Nginx (UID 65534) cần write permission:</p>
                <ul>
                    <li><code>/var/log/nginx</code>: Access logs</li>
                    <li><code>/run/nginx.pid</code>: PID file</li>
                    <li><code>/tmp</code>: Temp files</li>
                </ul>
            </section>

            <!-- Permission matrix -->
            <section>
                <h3>Permission Matrix</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Directory</th>
                            <th>Owner</th>
                            <th>Mode</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>/etc/nginx</td>
                            <td>root</td>
                            <td>0755</td>
                            <td>Read-only config</td>
                        </tr>
                        <tr>
                            <td>/usr/share/nginx/html</td>
                            <td>65534</td>
                            <td>0755</td>
                            <td>Static files</td>
                        </tr>
                        <tr>
                            <td>/var/log/nginx</td>
                            <td>65534</td>
                            <td>0755</td>
                            <td>Logs (stdout/err)</td>
                        </tr>
                        <tr>
                            <td>/run</td>
                            <td>65534</td>
                            <td>0755</td>
                            <td>PID file</td>
                        </tr>
                        <tr>
                            <td>/tmp</td>
                            <td>65534</td>
                            <td class="metric-value">1777</td>
                            <td>Temp + sticky bit</td>
                        </tr>
                        <tr>
                            <td>/usr/local/nginx/*_temp</td>
                            <td>65534</td>
                            <td>0755</td>
                            <td>Nginx temp dirs</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>Sticky bit (1777)</strong> on <code>/tmp</code>: Chỉ owner có thể delete files</p>
            </section>

            <!-- Stage 5 -->
            <section>
                <h2>2.5 Stage 5: Final Image (FROM SCRATCH)</h2>
                <p><strong>Mục đích:</strong> Tạo minimal production image với zero attack surface</p>
                <pre><code class="language-dockerfile">FROM scratch

# Re-declare build args for metadata
ARG BUILD_DATE
ARG GIT_COMMIT=unknown

# OCI metadata labels
LABEL org.opencontainers.image.title="Vite React - Distroless" \
      org.opencontainers.image.description="Distroless minimal image (<6MB) - UPX compressed" \
      org.opencontainers.image.version="2.2.0-distroless-upx" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${GIT_COMMIT}" \
      org.opencontainers.image.base.name="scratch" \
      org.opencontainers.image.source="https://github.com/riipandi/vite-react-template" \
      org.opencontainers.image.licenses="MIT OR Apache-2.0" \
      maintainer="contest-2025-optimized"

# Copy static nginx binary and minimal filesystem
COPY --from=nginx-builder /usr/local/nginx/sbin/nginx /usr/sbin/nginx
COPY --from=rootfs /rootfs /

# Run as non-root user (nobody = 65534)
USER 65534:65534

EXPOSE 3000

# Lightweight healthcheck using nginx config test
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD ["/usr/sbin/nginx", "-t", "-q"]

STOPSIGNAL SIGTERM

ENTRYPOINT ["/usr/sbin/nginx"]
CMD ["-g", "daemon off;"]
</code></pre>
            </section>

            <!-- FROM scratch explanation -->
            <section>
                <h3>Kỹ thuật 1: FROM scratch</h3>
                <p><strong>Giải thích FROM scratch:</strong></p>
                <pre><code>FROM alpine     → 7.5 MB base + 100+ packages
FROM debian     → 124 MB base + 400+ packages
FROM scratch    → 0 bytes, không có OS</code></pre>
                <p><strong>FROM scratch chỉ chứa:</strong></p>
                <ul>
                    <li>Files được COPY vào</li>
                    <li>Metadata (LABEL, ENV, etc.)</li>
                    <li>Không có shell, package manager, utilities</li>
                </ul>
            </section>

            <!-- Requirements for FROM scratch -->
            <section>
    <h3>Yêu cầu để dùng FROM scratch</h3>
    <ul>
        <li><strong>Static binary</strong> - Không phụ thuộc thư viện động</li>
        <li><strong>Minimal rootfs</strong> - Chỉ thêm thư mục/file thực sự cần</li>
        <li><strong>Direct execution</strong> - ENTRYPOINT gọi binary trực tiếp</li>
        <li><strong>No runtime tools</strong> - Không shell, không debugging tools</li>
    </ul>
    
    <p><strong>Our case:</strong></p>
    <ul>
        <li><span class="good">✓ </span>Nginx statically linked</li>
        <li><span class="good">✓ </span>Rootfs prepared in Stage 4</li>
        <li><span class="good">✓ </span>Binary execution: /usr/sbin/nginx</li>
        <li><span class="good">✓ </span>Production-only (no debugging)</li>
    </ul>
</section>

            <!-- FROM scratch benefits -->
            <section>
                <h3>Security benefits</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Alpine</th>
                            <th>Scratch</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Shell</strong></td>
                            <td>/bin/sh</td>
                            <td><span class="good">✓ None</span></td>
                        </tr>
                        <tr>
                            <td><strong>Utils</strong></td>
                            <td>~50 bins</td>
                            <td><span class="good">✓ None</span></td>
                        </tr>
                        <tr>
                            <td><strong>Package</strong></td>
                            <td>apk</td>
                            <td><span class="good">✓ None</span></td>
                        </tr>
                        <tr>
                            <td><strong>Libraries</strong></td>
                            <td>~100</td>
                            <td><span class="good">✓ None</span></td>
                        </tr>
                        <tr>
                            <td><strong>CVEs</strong></td>
                            <td><span class="bad">18-57</span></td>
                            <td><span class="good">✓ 0</span></td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top: 30px;"><em>"The best defense is to have nothing to attack"</em> <br><strong>- Defense in Depth principle</strong></p>
            </section>

            <!-- OCI Labels -->
            <section>
                <h3>Kỹ thuật 2: OCI Labels</h3>
                <pre><code class="language-dockerfile">LABEL org.opencontainers.image.title="Vite React" \
      org.opencontainers.image.version="2.2.0" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${GIT_COMMIT}" \
      org.opencontainers.image.base.name="scratch" \
      org.opencontainers.image.licenses="MIT"</code></pre>
                <p><strong>OCI Image Spec:</strong> Standard metadata format</p>
                <p><strong>Lợi ích của labels:</strong></p>
                <pre><code class="language-bash"># Inspect image metadata
docker inspect app:contest | jq '.[0].Config.Labels'

# Filter images by label
docker images --filter "label=org.opencontainers.image.title=Vite React"

# Used by registries
# Docker Hub, Harbor, Quay.io display labels</code></pre>
                <p><strong>Best practice:</strong> Include version, created date, commit hash</p>
            </section>

            <!-- Non-root USER -->
            <section>
                <h3>Kỹ thuật 3: Non-root USER</h3>
                <pre><code class="language-dockerfile">USER 65534:65534</code></pre>
                <p><strong>Security principle:</strong> Least privilege</p>
                <p><strong>65534 = nobody:</strong></p>
                <ul>
                    <li>Standard UID for unprivileged user</li>
                    <li>No special permissions</li>
                    <li>Can't modify system files</li>
                </ul>
            </section>

            <!-- Comparison root vs nobody -->
            <section>
                <h3>Comparison</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p class="bad"><strong>❌ Running as root</strong></p>
                        <pre><code class="language-dockerfile">USER root  # or không có USER directive
→ UID 0, có thể làm mọi thứ trong container</code></pre>
                    </div>
                    <div>
                        <p class="good"><strong>✓ Running as nobody</strong></p>
                        <pre><code class="language-dockerfile">USER 65534:65534
→ UID 65534, chỉ write vào owned dirs</code></pre>
                    </div>
                </div>
                <p><strong>Kịch bản khai thác:</strong></p>
                <pre>
1. Kẻ tấn công tìm thấy lỗ hổng RCE (Remote Code Execution) trên nginx
2. Thực thi lệnh shell với quyền USER

Root:   → Có thể ghi đè /usr/sbin/nginx, leo thang đặc quyền
Nobody: → Không thể ghi vào /usr/sbin, thiệt hại bị giới hạn
                </pre>
            </section>

            <!-- HEALTHCHECK -->
            <section>
                <h3>Kỹ thuật 4: HEALTHCHECK</h3>
                <pre><code class="language-dockerfile">HEALTHCHECK --interval=30s \
            --timeout=3s \
            --start-period=5s \
            --retries=3 \
  CMD ["/usr/sbin/nginx", "-t", "-q"]</code></pre>
                <p><strong>Giải thích từng parameter:</strong></p>
                <ul>
                    <li><code>--interval=30s</code>: Check mỗi 30 giây</li>
                    <li><code>--timeout=3s</code>: Command timeout</li>
                    <li><code>--start-period=5s</code>: Grace period sau start</li>
                    <li><code>--retries=3</code>: Fail sau 3 lần retry</li>
                </ul>
            </section>

            <!-- Health check command -->
            <section>
                <h3>Health check command</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 0.85em;">
                    <div>
                        <p class="bad"><strong>❌ HTTP healthcheck (common)</strong></p>
                        <pre><code class="language-dockerfile">HEALTHCHECK CMD curl -f http://localhost:3000/ || exit 1</code></pre>
                        <p><strong>Vấn đề:</strong></p>
                        <ul>
                            <li>Cần curl binary (thêm 2-3 MB)</li>
                            <li>Slower (TCP handshake + HTTP)</li>
                            <li>External dependency</li>
                        </ul>
                    </div>
                    <div>
                        <p class="good"><strong>✓ Config test (lightweight)</strong></p>
                        <pre><code class="language-dockerfile">CMD ["/usr/sbin/nginx", "-t", "-q"]</code></pre>
                        <p><strong>Ưu điểm:</strong></p>
                        <ul>
                            <li>No extra binary needed</li>
                            <li>Fast (~10ms)</li>
                            <li>Tests config validity</li>
                            <li>Works in FROM scratch</li>
                        </ul>
                        <p><strong>Trade-off:</strong> Không test HTTP endpoint (assume config OK = service OK)</p>
                    </div>
                </div>
            </section>

            <!-- END with Metrics -->
            <!-- Final Metrics Summary -->
            <section>
                <h2 style="text-align: center; color: #42affa;">Final Results</h2>
                <table>
                    <thead>
                        <tr>
                            <th colspan="2">METRICS SUMMARY</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Image size</strong></td>
                            <td><span class="metric-value">5.38 MB</span></td>
                        </tr>
                        <tr>
                            <td><strong>Base image</strong></td>
                            <td>scratch (0 MB)</td>
                        </tr>
                        <tr>
                            <td><strong>Layers</strong></td>
                            <td>2 data layers</td>
                        </tr>
                        <tr>
                            <td><strong>CVEs</strong></td>
                            <td><span class="metric-value">0 vulnerabilities</span></td>
                        </tr>
                        <tr>
                            <td><strong>Startup time</strong></td>
                            <td><span class="good">3-5 seconds</span></td>
                        </tr>
                        <tr>
                            <td><strong>Memory (idle)</strong></td>
                            <td><span class="good">10-12 MB</span></td>
                        </tr>
                        <tr>
                            <td><strong>Shutdown time</strong></td>
                            <td><span class="good">0.212 seconds</span></td>
                        </tr>
                        <tr>
                            <td><strong>HTTP response</strong></td>
                            <td><span class="good">&lt; 0.01s</span></td>
                        </tr>
                        <tr style="border-top: 2px solid rgba(255,255,255,0.3);">
                            <td><strong>Build time (cold)</strong></td>
                            <td>7.5 minutes</td>
                        </tr>
                        <tr>
                            <td><strong>Build time (warm)</strong></td>
                            <td><span class="good">45 seconds</span></td>
                        </tr>
                        <tr style="border-top: 2px solid rgba(255,255,255,0.3);">
                            <td><strong>vs nginx:alpine</strong></td>
                            <td><span class="metric-value">92.5% smaller</span></td>
                        </tr>
                        <tr>
                            <td><strong>vs nginx:latest</strong></td>
                            <td><span class="metric-value">97.2% smaller</span></td>
                        </tr>
                    </tbody>
                </table>
                <p style="text-align: center; margin-top: 40px; font-size: 1.2em;">
                    <strong>Cảm ơn đã lắng nghe!</strong>
                </p>
            </section>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.6.0/plugin/notes/notes.js"></script>
    <script>
        Reveal.initialize({
            hash: true,
            slideNumber: true,
            transition: 'slide',
            backgroundTransition: 'fade',
            center: false,
            width: 1920,
            height: 1080,
            margin: 0.04,
            plugins: [RevealHighlight, RevealMarkdown, RevealNotes],
            highlight: {
                highlightOnLoad: true,
                escapeHTML: false
            }
        });
        
        // Sidebar Toggle
        const toggleBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        toggleBtn.addEventListener('click', () => {
            toggleBtn.classList.toggle('active');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });
        
        overlay.addEventListener('click', () => {
            toggleBtn.classList.remove('active');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
        
        // Navigation with active slide tracking
        const sidebarLinks = document.querySelectorAll('#sidebar a');
        
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const slideIndex = parseInt(link.getAttribute('data-slide'));
                Reveal.slide(slideIndex);
                
                // Update active link
                sidebarLinks.forEach(l => l.classList.remove('active-slide'));
                link.classList.add('active-slide');
                
                // Close sidebar
                toggleBtn.classList.remove('active');
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        });
        
        // Track slide changes and update active link
        Reveal.on('slidechanged', event => {
            const currentSlide = event.indexh;
            sidebarLinks.forEach(link => {
                if (parseInt(link.getAttribute('data-slide')) === currentSlide) {
                    link.classList.add('active-slide');
                } else {
                    link.classList.remove('active-slide');
                }
            });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Press 'm' to toggle sidebar
            if (e.key === 'm' || e.key === 'M') {
                toggleBtn.click();
            }
            // Press 'Escape' to close sidebar
            if (e.key === 'Escape' && sidebar.classList.contains('active')) {
                toggleBtn.classList.remove('active');
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
